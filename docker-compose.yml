# ==============================================================================
# Docker Compose - Loja Virtual API (VersÃ£o Desenvolvimento)
# ==============================================================================
# 
# ðŸŽ¯ PARA A NAMORADA (desenvolvedora frontend):
# 
#   1. Instale o Docker Desktop: https://www.docker.com/products/docker-desktop
#   2. DÃª duplo-clique em INICIAR-API.bat
#   3. Acesse: http://localhost:4000/health
#
# ðŸ“Œ URLs disponÃ­veis:
#   - API:       http://localhost:4000
#   - Kafka UI:  http://localhost:8080
#
# ==============================================================================

services:
  # ============================================================================
  # API Elixir/Phoenix (Desenvolvimento com hot-reload)
  # ============================================================================
  api:
    image: elixir:1.17-alpine
    container_name: loja_virtual_api
    working_dir: /app
    volumes:
      - .:/app
      - elixir_deps:/app/deps
      - elixir_build:/app/_build
    ports:
      - "4000:4000"
    environment:
      MIX_ENV: dev
      DATABASE_HOST: postgres
      DATABASE_URL: ecto://postgres:postgres@postgres:5432/loja_virtual_dev
      KAFKA_HOST: kafka
      KAFKA_HOSTS: kafka:29092
      PHX_HOST: localhost
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    command: >
      sh -c "
        apk add --no-cache build-base git postgresql-client &&
        mix local.hex --force &&
        mix local.rebar --force &&
        mix deps.get &&
        echo 'Aguardando PostgreSQL...' &&
        until pg_isready -h postgres -p 5432 -U postgres; do sleep 2; done &&
        mix ecto.create &&
        mix ecto.migrate &&
        mix run priv/repo/seeds.exs --no-halt || true &&
        echo '' &&
        echo '=============================================' &&
        echo 'ðŸš€ API rodando em http://localhost:4000' &&
        echo '=============================================' &&
        echo '' &&
        mix phx.server
      "
    restart: unless-stopped

  # ============================================================================
  # PostgreSQL Database
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: loja_virtual_postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: loja_virtual_dev
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Zookeeper (necessÃ¡rio para Kafka)
  # ============================================================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: loja_virtual_zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Apache Kafka (mensageria)
  # ============================================================================
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: loja_virtual_kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 10s
      retries: 5

  # ============================================================================
  # Kafka UI (Interface visual para Kafka)
  # ============================================================================
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: loja_virtual_kafka_ui
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: loja_virtual
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      DYNAMIC_CONFIG_ENABLED: "true"

  # ============================================================================
  # InicializaÃ§Ã£o dos tÃ³picos Kafka
  # ============================================================================
  kafka-init:
    image: confluentinc/cp-kafka:7.5.0
    container_name: loja_virtual_kafka_init
    depends_on:
      kafka:
        condition: service_healthy
    restart: "no"
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "
      sleep 5
      kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic orders.new
      kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic orders.paid
      kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic stock.product.check
      kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic stock.ingredient.check
      kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic supply.needed
      kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic supply.shipment.created
      kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic stock.replenished
      kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic production.queue
      kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic shipping.ready
      echo 'Topicos Kafka criados!'
      "

# ==============================================================================
# Volumes (dados persistentes)
# ==============================================================================
volumes:
  postgres_data:
  elixir_deps:
  elixir_build:
